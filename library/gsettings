#!/usr/bin/python

# Modified by Michael Aquilina

import json
import re
import subprocess
import sys

from ansible.module_utils.basic import *

def _set_value(schema, key, value):
    try:
        return subprocess.check_output([
	    'gsettings', 'set', schema, key, value
        ]).strip()
    except subprocess.CalledProcessError as e:
        print e.output
        raise e

def _get_value(schema, key):
    return subprocess.check_output([
    	'gsettings', 'get', schema, key
    ]).strip()

def main():

    module = AnsibleModule(
        argument_spec = {
            'state': { 'choices': ['present'], 'default': 'present' },
            'schema': {'required': True},
            'key': { 'required': True },
            'value': { 'required': True },
        },
        supports_check_mode = True,
    )

    state = module.params['state']
    schema = module.params['schema']
    key = module.params['key']
    value = module.params['value']

    value = value.strip()
    value = value.replace('\n', '')

    old_value = _get_value(schema, key)
    changed = old_value != value

    if changed and not module.check_mode:
        _set_value(schema, key, value)

    print json.dumps({
        'changed': changed,
        'key': key,
        'value': value,
        'old_value': old_value,
    })

main()
